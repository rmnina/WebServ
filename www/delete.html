<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Webserv</title>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<link rel="stylesheet" href="assets/css/styles.css" />
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
		<link rel="shortcut icon" type="image/x-icon" href="https://i.postimg.cc/rmKr57y8/crane-favicon.png"/>
		
		<!-- Ajout du CSS pour décaler uniquement la liste -->
		<style>
			#file-list {
				padding-top: 80px;  /* Décale la liste sans affecter la navbar */
			}
		</style>
	</head>
	<body class="ParallaxMainContent">
		<div class="topnav">
			<a href="/" class="nav-link">Home</a>
			<a href="/#request" class="nav-link">Requests</a>
			<a href="/#script">CGI Scripts</a>
			<a href="/#review">Reviews</a>
		</div>
		<div id="file-list">
		</div>
		<script>
			let origin = location.origin;
			async function fetchFiles() {
				try {
					console.log(`On delete page, origin: ${origin}`);
					console.log(origin);
					const response = await fetch(`${origin}/cgi/list-files.cgi`);
					const data = await response.json();
					if (!response.ok) 
						throw new Error(`HTTP error! Status: ${response.status}`);
	
					const uploadDir = data.upload_dir;
					const files = data.files;
					const fileList = document.getElementById("file-list");
					fileList.innerHTML = "";
					console.log(`files: ${files}`);
					if (files == null || files.length == 0) 
						document.getElementById("file-list").innerHTML = "This is no more than a wasteland for now. Bring me something so that I can ERASE IT!"
					if (files)
					{
					files.forEach((fileName) => {
						const fileWrapper = document.createElement("div");
						let fileHTML = `<div class="file-item">`;
						if (fileName.match(/\.(jpg|jpeg|png|gif)$/i)) {
							fileHTML += `<img src="/${uploadDir}/${fileName}"
								alt="${fileName}"
								style="width: 10%"
								onerror="this.style.display='none'; this.nextElementSibling.style.display='inline'">
							<span style="display: inline">${fileName}</span>`;
						} else
							fileHTML += `<span>${fileName}</span>`;

						fileHTML += `
							<button id="trash-btn" onclick="deleteFile('${fileName}', '${uploadDir}')">
								<i class="fas fa-trash" id="trash"></i>
							</button><br>`;
						fileWrapper.innerHTML = fileHTML;
						fileList.appendChild(fileWrapper);
					});
					}
				} catch (error) {
					console.error("Error fetching file list:", error);
				}
			}

			window.onload = fetchFiles;

			function deleteFile(fileName, uploadDir) {
				if (confirm(`Are you sure you want to delete ${fileName}?`)) {
					console.log(`On delete page, origin: ${origin}`);
					fetch(`${origin}/${uploadDir}/${fileName}`, {
						method: 'DELETE',
						headers: {
							'Authorization': 'Bearer YOUR_ACCESS_TOKEN',
							'Content-Type': 'application/json'
						},
					}).then(response => {
						if (response.ok) {
                					console.log(`${fileName} successfully deleted.`);
							let fileItems = document.querySelectorAll(".file-item");
							fileItems.forEach(item => {
                    						let span = item.querySelector("span");
                   						let img = item.querySelector("img");
                    						if ((span && span.textContent === fileName) || (img && img.getAttribute("alt") === fileName))
									item.parentElement.remove(); // Supprime le conteneur entier
							});
					} else
						console.error(`Error: ${fileName}: ${response.status}`);
					}).catch((error) => {
						console.log("Error:", error);
					})
				}
		}
		</script>
	</body>
</html>
